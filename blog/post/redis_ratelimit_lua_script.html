<!DOCTYPE html><html lang="en" class="__className_aaf875"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/images/token_bucket.png"/><link rel="preload" as="image" href="/images/leak_bucket.png"/><link rel="preload" as="image" href="/images/fixed_window_counter.png"/><link rel="preload" as="image" href="/images/sliding_window_log.png"/><link rel="preload" as="image" href="/images/sliding_window_counter.png"/><link rel="preload" as="image" href="/images/ratelimit_result_latency.png"/><link rel="stylesheet" href="/_next/static/css/8ae19ecead919bb5.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-eaec8c52eea67789.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-28d8581e6e02654e.js" async="" crossorigin=""></script><script src="/_next/static/chunks/69-8dcc56abbf5d7aaf.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-84610adbc45a3c3f.js" async="" crossorigin=""></script><script src="/_next/static/chunks/8e1d74a4-1e017a85df66f066.js" async=""></script><script src="/_next/static/chunks/792-141a1b4a1ae1a295.js" async=""></script><script src="/_next/static/chunks/app/layout-7d0d944cfe9ed1fc.js" async=""></script><title>redis와 lua스크립트를 이용한 처리율 제한 장치 만들기</title><meta name="description" content="redis와 lua스크립트를 이용한 처리율 제한 장치를 만드는 포스팅입니다."/><meta name="keywords" content="ratelimit, redis ratelimi, Rate limiting, Rate limiting lua, lua script, 처리율 제한장치"/><meta property="og:title" content="redis와 lua스크립트를 이용한 처리율 제한 장치 만들기"/><meta property="og:description" content="redis와 lua스크립트를 이용한 처리율 제한 장치를 만드는 포스팅입니다."/><meta property="og:url" content="https://beenchangseo.github.io/redis_ratelimit_lua_script"/><meta property="og:site_name" content="Beenchangseo Blog"/><meta property="og:locale" content="ko_KR"/><meta property="og:type" content="article"/><meta property="article:tag" content="ratelimit"/><meta property="article:tag" content="redis ratelimi"/><meta property="article:tag" content="Rate limiting"/><meta property="article:tag" content="Rate limiting lua"/><meta property="article:tag" content="lua script"/><meta property="article:tag" content="처리율 제한장치"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="beenchangseo"/><meta name="twitter:title" content="redis와 lua스크립트를 이용한 처리율 제한 장치 만들기"/><meta name="twitter:description" content="redis와 lua스크립트를 이용한 처리율 제한 장치를 만드는 포스팅입니다."/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body><header class="sticky top-0 left-0 w-full z-10 h-20 font-mono transition duration-500 bg-white dark:bg-[#111111]"><div class="max-w-screen-md h-20 flex flex-nowrap items-center justify-between m-auto px-8"><a href="/"><h1 class="font-bold stroke-black dark:stroke-white">BEENCHANGSEO.DEV</h1></a><div class="flex flex-nowrap gap-8 items-center"><button type="button" class="m-0 p-0 sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 transition duration-500 stroke-black dark:stroke-white"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg></button><div class="flex-nowrap items-center justify-center gap-5 text-center hidden sm:flex"><a class="dark:text-white dark:hover:text-green-500 text-center transition duration-250 hover:scale-125 hover:text-green-500" href="/">Home</a><a class="dark:text-white dark:hover:text-green-500 text-center transition duration-250 hover:scale-125 hover:text-green-500" href="/blog">Blog</a><a class="dark:text-white dark:hover:text-green-500 text-center transition duration-250 hover:scale-125 hover:text-green-500" href="/category">Category</a></div></div></div><div class="w-full h-screen absolute top-20 left-0 bg-white flex-col flex-nowrap p-5 flex hidden dark:bg-[#111111]"><a class="dark:text-white dark:hover:text-green-500 text-center transition duration-250 hover:scale-125 hover:text-green-500 text-lg py-4" href="/">Home</a><a class="dark:text-white dark:hover:text-green-500 text-center transition duration-250 hover:scale-125 hover:text-green-500 text-lg py-4" href="/blog">Blog</a><a class="dark:text-white dark:hover:text-green-500 text-center transition duration-250 hover:scale-125 hover:text-green-500 text-lg py-4" href="/category">Category</a></div></header><main class="transition duration-500 bg-white dark:bg-[#111111] text-black dark:text-white"><div class="max-w-screen-md flex flex-col px-10 m-auto"><section><div class="mt-10 pb-10 border-b-2 mb-10 prose dark:prose-invert"><h1 class="mb-16 font-bold text-2xl sm:text-4xl font-mono">redis와 lua스크립트를 이용한 처리율 제한 장치 만들기</h1><h3>처리율 제한 장치(rate limiter)를 개선해보자</h3>
<p>사내 서비스의 처리율 제한 장치(rate limiter)의 개선 프로젝트를 하게되었다.</p>
<p>처리율 제한 장치(rate limiter)는 클라이언트 또는 서비스가 보내는 트래픽의 처리율(rate)을 제어하기 위한 장치이다.</p>
<p>이 기술은 서비스나 애플리케이션에 너무 많은 요청이 한꺼번에 몰리는 것을 방지하여, 서버가 안정적으로 운영될 수 있도록 돕습니다.</p>
<h3>요구사항은?</h3>
<p>요구사항은 다음과 같았다.</p>
<blockquote>
<p>Rate limiter용 공통 라이브러리 제작 후 현재 여러 형태로 처리하고 있는 rate limiter을 일관 되게 처리 할 수 있도록 합니다.</p>
</blockquote>
<p>기존에는 여기저기 파편적으로 rate limit 로직이 구현되어 있었으며, 로직이 제대로 동작하지 않는 경우도 빈번하게 발생하고 있었다.</p>
<h3>어떻게 구현(개선)할 것인가?</h3>
<ol>
<li>기존 코드에 영향을 주지 않게 인터페이스 변경은 최소화한다.</li>
<li>redis 접근을 최소화하여 트랜잭션 오버헤드를 줄인다.</li>
<li>atomic을 보장하기 위해 lua 스크립트로 작성한다.</li>
<li>연산을 최소화한다.</li>
<li>요구사항에 알맞는 처리율 제한 알고리즘을 사용한다.</li>
</ol>
<h3>처리율 제한 알고리즘이 뭔데?</h3>
<ul>
<li>토큰 버킷(token bucket)</li>
<li>누출 버킷(leaky bucket)</li>
<li>고정 윈도 카운터(fixed window counter)</li>
<li>이동 윈도 로그(sliding window log)</li>
<li>이동 윈도 카운터(sliding window counter)</li>
</ul>
<h3>처리율 제한 알고리즘 설명</h3>
<details><summary> 접기 / 펼치기 </summary><h4>토큰 버킷 (Token Bucket) 알고리즘</h4><h5>동작 원리</h5><ul>
<li><strong>버킷</strong>: 이 버킷은 토큰을 저장하는 곳입니다. 시스템에 들어오는 각 요청을 처리하기 위해 토큰을 하나씩 사용합니다.</li>
<li><strong>토큰 추가</strong>: 정해진 속도로 버킷에 토큰이 추가됩니다. 만약 버킷이 가득 차면, 추가되지 않은 토큰은 사라집니다.</li>
<li><strong>요청 처리</strong>: 요청이 들어오면, 버킷에서 토큰을 하나 꺼내 요청을 처리합니다. 토큰이 없으면, 요청은 처리될 때까지 기다려야 합니다.
<img src="/images/token_bucket.png" alt="token_bucket"/></li>
</ul><h5>장점</h5><ul>
<li>구현이 쉽습니다.</li>
<li>메모리 사용 측면에서 효율적입니다.</li>
<li><strong>유연성</strong>: 트래픽이 일시적으로 증가하는 경우, 미리 축적된 토큰을 사용해 이를 처리할 수 있습니다.</li>
<li><strong>안정성</strong>: 요청이 폭발적으로 증가하는 경우에도 시스템이 정해진 속도로만 처리하기 때문에 시스템이 안정적으로 유지됩니다.</li>
</ul><h5>단점</h5><ul>
<li><strong>복잡성</strong>: 구현과 관리가 상대적으로 복잡할 수 있습니다. 특히, 분산 시스템에서는 토큰의 동기화와 관리가 더 어려워질 수 있습니다.</li>
<li><strong>토큰 버킷 크기</strong>: 버킷의 크기를 적절히 설정하지 않으면, 너무 많은 트래픽을 한꺼번에 처리하려 해서 시스템에 부하를 줄 수 있습니다.</li>
</ul><h4>노출 버킷 (Leaky Bucket) 알고리즘</h4><h5>동작 원리</h5><ul>
<li><strong>버킷</strong>: 버킷은 들어오는 요청(물)을 저장하는 역할을 합니다.</li>
<li><strong>노출(Leak)</strong>: 버킷에 구멍이 나 있어서 일정한 속도로 물이 빠져나갑니다. 이 빠져나가는 물은 시스템이 처리할 수 있는 요청을 의미합니다.</li>
<li><strong>과부하</strong>: 버킷(버퍼)가 가득 차면, 새로운 요청은 버릴 수 있습니다. 이는 네트워크 혼잡 상황에서 시스템이 넘치지 않게 하는 역할을 합니다.
<img src="/images/leak_bucket.png" alt="leak_bucket"/></li>
</ul><h5>장점</h5><ul>
<li>큐의 크기가 제한되어 있어 메모리 사용량 측면에서 효율적입니다.</li>
<li><strong>균일한 처리율</strong>: 시스템이 일정한 속도로 요청을 처리하므로, 트래픽 폭증 시에도 안정적입니다.</li>
<li><strong>간단한 구현</strong>: 노출 버킷 알고리즘은 구현하기가 비교적 간단하며, 이해하기 쉽습니다.</li>
</ul><h5>단점</h5><ul>
<li><strong>유연성 부족</strong>: 일정한 속도로만 요청을 처리할 수 있으므로, 일시적인 트래픽 증가에 유연하게 대응하기 어렵습니다.</li>
<li><strong>버퍼 오버플로우</strong>: 요청이 많이 들어올 경우 버킷이 가득 차서 새로운 요청을 버려야 할 수 있습니다. 이는 요청 손실을 의미합니다.</li>
</ul><h4>고정 윈도 카운터 (Fixed Window Counter) 알고리즘</h4><h5>동작 원리</h5><ul>
<li><strong>시간 윈도 설정</strong>: 고정 윈도 카운터는 전체 시간을 동일한 크기의 &#x27;윈도&#x27;로 나눕니다. 예를 들어, 하루를 24개의 1시간짜리 윈도로 나눌 수 있습니다.</li>
<li><strong>카운터</strong>: 각 윈도마다 하나의 카운터가 있습니다. 요청이 들어올 때마다 해당 윈도의 카운터가 1씩 증가합니다.</li>
<li><strong>요청 제한</strong>: 각 윈도에 설정된 한계에 도달하면, 그 윈도에서는 더 이상 요청을 받지 않습니다. 새 윈도가 시작될 때까지 기다려야 합니다.
<img src="/images/fixed_window_counter.png" alt="fixed_window_counter"/></li>
</ul><h5>장점</h5><ul>
<li><strong>단순성</strong>: 구현하기 쉽고 이해하기 간단합니다. 복잡한 알고리즘이 필요 없는 작은 시스템이나 애플리케이션에 적합할 수 있습니다.</li>
<li><strong>성능</strong>: 카운터만 업데이트하면 되기 때문에, 매우 빠르고 효율적입니다.</li>
</ul><h5>단점</h5><ul>
<li><strong>버스트 트래픽 처리 어려움</strong>: 윈도가 바뀔 때마다 요청 한도가 초기화되므로, 윈도가 바뀌는 순간에 요청이 몰리면 시스템에 큰 부하가 발생할 수 있습니다.</li>
<li><strong>정확한 제한 어려움</strong>: 정확한 초 단위로 요청을 제한하기 어렵습니다. 예를 들어, 1분 윈도에서 60개의 요청을 허용하는 경우, 첫 10초에 모든 요청이 몰릴 수도 있습니다.</li>
</ul><h4>이동 윈도 로그 (Sliding Window Log) 알고리즘</h4><h5>동작 원리</h5><p>이동 윈도 로그 알고리즘은 시간의 흐름에 따라 요청을 유연하게 처리할 수 있는 방법입니다. 이 알고리즘은 윈도의 고정된 크기를 유지하면서 시간이 지남에 따라 윈도를 &#x27;슬라이딩&#x27; 시키는 방식으로 작동합니다.</p><ul>
<li><strong>로그 기록</strong>: 각 요청이 들어올 때, 그 요청의 타임스탬프를 로그에 기록합니다. 타임스탬프 데이터는 보통 Redis의 정렬 집합(sorted set)같은 캐시에 보관합니다.</li>
<li><strong>이동 윈도</strong>: 현재 시간을 기준으로 과거 일정 시간(예: 1분) 동안의 요청만을 고려합니다. 시간이 지나면서 이 윈도는 계속 앞으로 이동합니다.</li>
<li><strong>윈도 업데이트</strong>: 새로운 요청이 들어올 때마다 윈도를 업데이트하여, 오래된 요청을 윈도에서 제거하고 최근 요청을 포함시킵니다.
<img src="/images/sliding_window_log.png" alt="sliding_window_log"/></li>
</ul><h5>장점</h5><ul>
<li><strong>유연성</strong>: 이동 윈도 로그는 시간이 지남에 따라 요청을 더 유연하게 처리할 수 있어, 순간적인 트래픽 증가에도 잘 대응할 수 있습니다.</li>
<li><strong>정밀한 제어</strong>: 어느 순간의 윈도를 보더라도 허용되는 요청의 개수는 시스템의 처리율 한도를 넘지 않습니다.</li>
</ul><h5>단점</h5><ul>
<li><strong>자원 소모</strong>: 각 요청의 타임스탬프를 저장하고 관리해야 하므로, 많은 요청을 처리하는 시스템에서는 메모리 사용량이 증가할 수 있습니다.</li>
<li><strong>구현 복잡성</strong>: 이동 윈도 로그 알고리즘은 다른 방법에 비해 구현이 복잡할 수 있으며, 정확한 시간 관리와 로그 처리가 필요합니다.</li>
</ul><h4>이동 윈도 카운터 (Sliding Window Counter) 알고리즘</h4><h5>동작 원리</h5><p>이동 윈도 카운터 알고리즘은 처리율을 제한하고, 시스템의 부하를 관리하는 데 사용되는 방법입니다. 이 알고리즘은 특히 동적인 웹 애플리케이션과 서비스에서 유용하게 사용됩니다.</p><ul>
<li><strong>시간 윈도</strong>: 시간을 작은 단위로 나누어 각 단위마다 요청 수를 세는 카운터를 둡니다.</li>
<li><strong>이동</strong>: 윈도는 시간이 지남에 따라 &#x27;이동&#x27;합니다. 즉, 새로운 시간 단위가 시작될 때마다 최신 요청을 반영하여 카운터를 업데이트합니다.</li>
<li><strong>요청 제한</strong>: 설정된 시간 동안 허용된 최대 요청 수를 넘으면, 추가 요청은 거부되거나 지연됩니다.
<img src="/images/sliding_window_counter.png" alt="sliding_window_counter"/></li>
</ul><h5>장점</h5><ul>
<li>이전 시간대의 평균 처리율에 따라 현재 윈도의 상태를 계산하므로 짧은 시간에 몰리는 트래픽에 잘 대응합니다.</li>
<li><strong>정밀한 제어</strong>: 시간 단위로 요청을 세밀하게 관리할 수 있어, 순간적인 트래픽 증가에도 유연하게 대응할 수 있습니다.</li>
<li><strong>효율적인 자원 사용</strong>: 고정 윈도 카운터에 비해 더 많은 요청을 처리할 수 있으며, 자원을 보다 효율적으로 사용합니다.</li>
</ul><h5>단점</h5><ul>
<li><strong>구현 복잡성</strong>: 이동 윈도 카운터는 구현이 복잡할 수 있으며, 시간 관리와 카운터 업데이트에 주의가 필요합니다.</li>
<li><strong>메모리 사용량</strong>: 각 시간 단위마다 카운터를 유지해야 하므로, 많은 요청을 처리하는 시스템에서는 메모리 사용량이 증가할 수 있습니다.</li>
</ul></details>
<h3>구현</h3>
<p>처리율 제한 로직의 신규 정책은 토큰 버킷알고리즘을 조금 변경하여 구현해야 했다.
정책은 다음과 같았다.</p>
<blockquote>
<ul>
<li>rate(초)동안 count(요청횟수)회 허용한다고 가정한다.</li>
<li>최초 요청이 들어왔을 때 rate(초) 타이머가 동작한다.</li>
<li>rate(초)범위 안에서는 count(요청횟수)회 연속으로 요청을 할 수 있다.</li>
<li>최초 요청으로부터 rate(초) 뒤 요청 할 수 있는 토큰이 한번에 생성된다. (count 개수만큼)</li>
<li>rate(초)안에 토큰을 전부 사용하지 못하더라도 토큰이 생성 될 때는 최대치인 count개를 넘지 않는다.</li>
<li>토큰을 전부 사용 했을 때 요청 거부와 다음 토큰이 생성되기까지 남은 시간을 반환한다.</li>
<li>rate(초)에 적용 할 수 있는 최소 주기는 0.00005초 이다.</li>
</ul>
</blockquote>
<p>위 알고리즘 방식은 특정 구간(토큰이 생성되는 시간 앞뒤)에서 최대 2n - 1개의 요청이 몰릴 수 있으니 참고하자.</p>
<h3>처리율 제한 장치(rate limiter) 개선</h3>
<p>rate limiter 개선 후 datadog에서 latency 그래프를 보았을 때 개선정도를 육안으로 확인 할 수 있었다.
<img src="/images/ratelimit_result_latency.png" alt="ratelimit_result_latency"/></p>
<h4>lua 스크립트 코드</h4>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#24292e;color:#e1e4e8" tabindex="0" data-language="lua" data-theme="github-dark"><code data-language="lua" data-theme="github-dark" style="display:grid"><span data-line=""> </span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> keys </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> redis.</span><span style="color:#79B8FF">call</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#x27;mget&#x27;</span><span style="color:#E1E4E8">, KEYS[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], KEYS[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">]) </span><span style="color:#6A737D">-- 두 키의 값을 한번에 가져옴</span></span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> tokens </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> tonumber</span><span style="color:#E1E4E8">(keys[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">or</span><span style="color:#79B8FF"> tonumber</span><span style="color:#E1E4E8">(ARGV[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]) </span><span style="color:#6A737D">-- 현재 버킷의 토큰 개수</span></span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> last_fill </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> tonumber</span><span style="color:#E1E4E8">(keys[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">or</span><span style="color:#79B8FF"> tonumber</span><span style="color:#E1E4E8">(ARGV[</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">]) </span><span style="color:#6A737D">-- 마지막으로 토큰이 충전된 시간</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> capacity </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> tonumber</span><span style="color:#E1E4E8">(ARGV[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]) </span><span style="color:#6A737D">-- 버킷의 최대 토큰 수</span></span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> refill_interval </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> tonumber</span><span style="color:#E1E4E8">(ARGV[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">]) </span><span style="color:#6A737D">-- 토큰이 다시 채워지는 시간 간격 (초)</span></span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> now </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> tonumber</span><span style="color:#E1E4E8">(ARGV[</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">]) </span><span style="color:#6A737D">-- 현재 시간</span></span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> ttl </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> refill_interval </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 2</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 1000</span><span style="color:#6A737D"> -- 넉넉하게 ttl값 설정 (초)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">-- 경과 시간 계산</span></span>
<span data-line=""><span style="color:#F97583">local</span><span style="color:#E1E4E8"> elapsed </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> now </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> last_fill</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">-- 충전 시간이 경과 했거나 첫 요청(elapsed == 0)인 경우 토큰을 최대로 채움</span></span>
<span data-line=""><span style="color:#F97583">if</span><span style="color:#E1E4E8"> elapsed </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> refill_interval </span><span style="color:#F97583">or</span><span style="color:#E1E4E8"> elapsed </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> then</span></span>
<span data-line=""><span style="color:#E1E4E8">    tokens </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> capacity</span></span>
<span data-line=""><span style="color:#E1E4E8">    redis.</span><span style="color:#79B8FF">call</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#x27;psetex&#x27;</span><span style="color:#E1E4E8">, KEYS[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], ttl, tokens)</span></span>
<span data-line=""><span style="color:#E1E4E8">    redis.</span><span style="color:#79B8FF">call</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#x27;psetex&#x27;</span><span style="color:#E1E4E8">, KEYS[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">], ttl, now)</span></span>
<span data-line=""><span style="color:#F97583">end</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">if</span><span style="color:#E1E4E8"> tokens </span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> then</span></span>
<span data-line=""><span style="color:#6A737D">    -- 토큰이 있는 경우, 토큰 하나 소모</span></span>
<span data-line=""><span style="color:#E1E4E8">    tokens </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tokens </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span></span>
<span data-line=""><span style="color:#E1E4E8">    redis.</span><span style="color:#79B8FF">call</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#x27;psetex&#x27;</span><span style="color:#E1E4E8">, KEYS[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], ttl, tokens)</span></span>
<span data-line=""><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, tokens, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">} </span><span style="color:#6A737D">-- 요청 허용, 남은 토큰 수, 대기 시간 0초 반환</span></span>
<span data-line=""><span style="color:#F97583">else</span></span>
<span data-line=""><span style="color:#6A737D">    -- 토큰이 없으면 다음 충전 시간까지 기다려야 함</span></span>
<span data-line=""><span style="color:#F97583">    local</span><span style="color:#E1E4E8"> time_to_next_refill </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> refill_interval </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> elapsed</span></span>
<span data-line=""><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, tokens, time_to_next_refill} </span><span style="color:#6A737D">-- 요청 거부, 남은 토큰 수, 대기 시간 반환</span></span>
<span data-line=""><span style="color:#F97583">end</span></span></code></pre></figure>
<h4>ratelimit.ts 코드</h4>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#24292e;color:#e1e4e8" tabindex="0" data-language="typescript" data-theme="github-dark"><code data-language="typescript" data-theme="github-dark" style="display:grid"><span data-line=""><span style="color:#F97583">import</span><span style="color:#E1E4E8"> assert </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> &#x27;assert&#x27;</span><span style="color:#E1E4E8">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">type</span><span style="color:#B392F0"> Rate</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">number</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">number</span><span style="color:#E1E4E8">];</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">type</span><span style="color:#B392F0"> RateLimitResponse</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span data-line=""><span style="color:#FFAB70">    available</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span data-line=""><span style="color:#FFAB70">    retryAfter</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span data-line=""><span style="color:#E1E4E8">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">const</span><span style="color:#79B8FF"> TOKEN_BUCKET_BUST_FILL_ALGO</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> &#x27;lua script...&#x27;</span><span style="color:#E1E4E8">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">export</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> RateLimitV2</span><span style="color:#E1E4E8"> {</span></span>
<span data-line=""><span style="color:#F97583">    static</span><span style="color:#FFAB70"> bustFillLuaScript</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> TOKEN_BUCKET_BUST_FILL_ALGO</span><span style="color:#E1E4E8">;</span></span>
<span data-line=""><span style="color:#F97583">    static</span><span style="color:#FFAB70"> bustFillLuaScriptHash</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> crypto</span></span>
<span data-line=""><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">createHash</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#x27;sha1&#x27;</span><span style="color:#E1E4E8">)</span></span>
<span data-line=""><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">update</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">TOKEN_BUCKET_BUST_FILL_ALGO</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#x27;utf8&#x27;</span><span style="color:#E1E4E8">)</span></span>
<span data-line=""><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">digest</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#x27;hex&#x27;</span><span style="color:#E1E4E8">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // ...중략</span></span>
<span data-line=""><span style="color:#F97583">    constructor</span><span style="color:#E1E4E8">() {</span></span>
<span data-line=""><span style="color:#E1E4E8">        </span></span>
<span data-line=""><span style="color:#6A737D">        // ...중략</span></span>
<span data-line=""><span style="color:#E1E4E8">    }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">    static</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> ratelimit</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">client</span><span style="color:#F97583">:</span><span style="color:#B392F0"> RedisClientType</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">keyPfx</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">rate</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Rate</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">RateLimitResponse</span><span style="color:#E1E4E8">&gt; {</span></span>
<span data-line=""><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (rate[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span data-line=""><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> {</span></span>
<span data-line=""><span style="color:#E1E4E8">                available: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span data-line=""><span style="color:#E1E4E8">                retryAfter: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span data-line=""><span style="color:#E1E4E8">            };</span></span>
<span data-line=""><span style="color:#E1E4E8">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#B392F0">        assert</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0.0005</span><span style="color:#F97583"> &lt;=</span><span style="color:#E1E4E8"> rate[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">], </span><span style="color:#9ECBFF">&#x27;ratelimit time is too small&#x27;</span><span style="color:#E1E4E8">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">        // KEYS</span></span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> baseKey</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> `${</span><span style="color:#E1E4E8">keyPfx</span><span style="color:#9ECBFF">}.ratelimit`</span><span style="color:#E1E4E8">;</span></span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> keys</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">baseKey</span><span style="color:#9ECBFF">}.tokens`</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">baseKey</span><span style="color:#9ECBFF">}.timestamp`</span><span style="color:#E1E4E8">];</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">        // ARGS (인자값 순서 주의)</span></span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> capacity</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> rate[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">].</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">();</span></span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> refillInterval</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> rate[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">].</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">();</span></span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> now</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">/</span><span style="color:#79B8FF"> 1000</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">();</span></span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> args</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [capacity, refillInterval, now];</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> scriptLoaded</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> client.</span><span style="color:#B392F0">scriptExists</span><span style="color:#E1E4E8">(RateLimitV2.bustFillLuaScriptHash);</span></span>
<span data-line=""><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">scriptLoaded[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]) {</span></span>
<span data-line=""><span style="color:#F97583">            await</span><span style="color:#E1E4E8"> client.</span><span style="color:#B392F0">scriptLoad</span><span style="color:#E1E4E8">(RateLimitV2.bustFillLuaScript);</span></span>
<span data-line=""><span style="color:#E1E4E8">        }</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">        const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> client.</span><span style="color:#B392F0">evalSha</span><span style="color:#E1E4E8">(RateLimitV2.bustFillLuaScriptHash, {keys, arguments: args});</span></span>
<span data-line=""><span style="color:#B392F0">        assert</span><span style="color:#E1E4E8">(result.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ===</span><span style="color:#79B8FF"> 3</span><span style="color:#E1E4E8">);</span></span>
<span data-line=""><span style="color:#B392F0">        assert</span><span style="color:#E1E4E8">(result[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> result[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span data-line=""><span style="color:#B392F0">        assert</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">typeof</span><span style="color:#E1E4E8"> result[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> &#x27;number&#x27;</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#F97583"> typeof</span><span style="color:#E1E4E8"> result[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> &#x27;number&#x27;</span><span style="color:#E1E4E8">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> {</span></span>
<span data-line=""><span style="color:#E1E4E8">            available: result[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">,</span></span>
<span data-line=""><span style="color:#E1E4E8">            retryAfter: result[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 1000</span><span style="color:#E1E4E8">,</span></span>
<span data-line=""><span style="color:#E1E4E8">        };</span></span>
<span data-line=""><span style="color:#E1E4E8">    }</span></span>
<span data-line=""><span style="color:#E1E4E8">}</span></span></code></pre></figure></div></section></div></main><footer class="w-full font-mono flex flex-col justify-center items-center pt-10 pb-6 transition duration-500 bg-white dark:bg-[#111111] dark:text-white text-black"><div class="flex justify-center gap-4 items-center pt-4 border-t-2 w-36"><a href="beenchangseo@gmail.com" class="hover:scale-110 transition-transform duration-500 hover:text-green-500 hover:fill-green-500 dark:fill-white dark:hover:fill-green-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z"></path></svg></a><a href="https://github.com/beenchangseo" class="hover:scale-110 transition-transform duration-500 hover:text-green-500 hover:fill-green-500 dark:fill-white dark:hover:fill-green-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></div><div class="text-sm mt-2">Copyright © 2024 Changbeen seo</div><div class="text-xs mt-2">beenchangseo</div></footer><script src="/_next/static/chunks/webpack-eaec8c52eea67789.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/c9a5bc6a7c948fb0-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/8ae19ecead919bb5.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I[7690,[],\"\"]\n6:I[5613,[],\"\"]\n8:I[1778,[],\"\"]\n9:I[7629,[\"699\",\"static/chunks/8e1d74a4-1e017a85df66f066.js\",\"792\",\"static/chunks/792-141a1b4a1ae1a295.js\",\"185\",\"static/chunks/app/layout-7d0d944cfe9ed1fc.js\"],\"\"]\na:I[102,[\"699\",\"static/chunks/8e1d74a4-1e017a85df66f066.js\",\"792\",\"static/chunks/792-141a1b4a1ae1a295.js\",\"185\",\"static/chunks/app/layout-7d0d944cfe9ed1fc.js\"],\"\"]\nc:I[8955,[],\"\"]\n7:[\"slug\",\"redis_ratelimit_lua_script\",\"d\"]\nd:[]\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/8ae19ecead919bb5.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"OQ6pT9DnuKuC2vO2kTPbz\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/blog/post/redis_ratelimit_lua_script\",\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"redis_ratelimit_lua_script\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"redis_ratelimit_lua_script\\\"}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"redis_ratelimit_lua_script\",\"d\"],{\"children\":[\"__PAGE__\",{},[\"$L5\",[\"$\",\"section\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"mt-10 pb-10 border-b-2 mb-10 prose dark:prose-invert\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-16 font-bold text-2xl sm:text-4xl font-mono\",\"children\":\"redis와 lua스크립트를 이용한 처리율 제한 장치 만들기\"}],[[\"$\",\"h3\",null,{\"children\":\"처리율 제한 장치(rate limiter)를 개선해보자\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"사내 서비스의 처리율 제한 장치(rate limiter)의 개선 프로젝트를 하게되었다.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"처리율 제한 장치(rate limiter)는 클라이언트 또는 서비스가 보내는 트래픽의 처리율(rate)을 제어하기 위한 장치이다.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"이 기술은 서비스나 애플리케이션에 너무 많은 요청이 한꺼번에 몰리는 것을 방지하여, 서버가 안정적으로 운영될 수 있도록 돕습니다.\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"요구사항은?\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"요구사항은 다음과 같았다.\"}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"Rate limiter용 공통 라이브러리 제작 후 현재 여러 형태로 처리하고 있는 rate limiter을 일관 되게 처리 할 수 있도록 합니다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"기존에는 여기저기 파편적으로 rate limit 로직이 구현되어 있었으며, 로직이 제대로 동작하지 않는 경우도 빈번하게 발생하고 있었다.\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"어떻게 구현(개선)할 것인가?\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"기존 코드에 영향을 주지 않게 인터페이스 변경은 최소화한다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"redis 접근을 최소화하여 트랜잭션 오버헤드를 줄인다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"atomic을 보장하기 위해 lua 스크립트로 작성한다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"연산을 최소화한다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"요구사항에 알맞는 처리율 제한 알고리즘을 사용한다.\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"처리율 제한 알고리즘이 뭔데?\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"토큰 버킷(token bucket)\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"누출 버킷(leaky bucket)\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"고정 윈도 카운터(fixed window counter)\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"이동 윈도 로그(sliding window log)\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"이동 윈도 카운터(sliding window counter)\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"처리율 제한 알고리즘 설명\"}],\"\\n\",[\"$\",\"details\",null,{\"children\":[[\"$\",\"summary\",null,{\"children\":\" 접기 / 펼치기 \"}],[\"$\",\"h4\",null,{\"children\":\"토큰 버킷 (Token Bucket) 알고리즘\"}],[\"$\",\"h5\",null,{\"children\":\"동작 원리\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"버킷\"}],\": 이 버킷은 토큰을 저장하는 곳입니다. 시스템에 들어오는 각 요청을 처리하기 위해 토큰을 하나씩 사용합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"토큰 추가\"}],\": 정해진 속도로 버킷에 토큰이 추가됩니다. 만약 버킷이 가득 차면, 추가되지 않은 토큰은 사라집니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"요청 처리\"}],\": 요청이 들어오면, 버킷에서 토큰을 하나 꺼내 요청을 처리합니다. 토큰이 없으면, 요청은 처리될 때까지 기다려야 합니다.\\n\",[\"$\",\"img\",null,{\"src\":\"/images/token_bucket.png\",\"alt\":\"token_bucket\"}]]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"장점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"구현이 쉽습니다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"메모리 사용 측면에서 효율적입니다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"유연성\"}],\": 트래픽이 일시적으로 증가하는 경우, 미리 축적된 토큰을 사용해 이를 처리할 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"안정성\"}],\": 요청이 폭발적으로 증가하는 경우에도 시스템이 정해진 속도로만 처리하기 때문에 시스템이 안정적으로 유지됩니다.\"]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"단점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"복잡성\"}],\": 구현과 관리가 상대적으로 복잡할 수 있습니다. 특히, 분산 시스템에서는 토큰의 동기화와 관리가 더 어려워질 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"토큰 버킷 크기\"}],\": 버킷의 크기를 적절히 설정하지 않으면, 너무 많은 트래픽을 한꺼번에 처리하려 해서 시스템에 부하를 줄 수 있습니다.\"]}],\"\\n\"]}],[\"$\",\"h4\",null,{\"children\":\"노출 버킷 (Leaky Bucket) 알고리즘\"}],[\"$\",\"h5\",null,{\"children\":\"동작 원리\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"버킷\"}],\": 버킷은 들어오는 요청(물)을 저장하는 역할을 합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"노출(Leak)\"}],\": 버킷에 구멍이 나 있어서 일정한 속도로 물이 빠져나갑니다. 이 빠져나가는 물은 시스템이 처리할 수 있는 요청을 의미합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"과부하\"}],\": 버킷(버퍼)가 가득 차면, 새로운 요청은 버릴 수 있습니다. 이는 네트워크 혼잡 상황에서 시스템이 넘치지 않게 하는 역할을 합니다.\\n\",[\"$\",\"img\",null,{\"src\":\"/images/leak_bucket.png\",\"alt\":\"leak_bucket\"}]]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"장점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"큐의 크기가 제한되어 있어 메모리 사용량 측면에서 효율적입니다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"균일한 처리율\"}],\": 시스템이 일정한 속도로 요청을 처리하므로, 트래픽 폭증 시에도 안정적입니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"간단한 구현\"}],\": 노출 버킷 알고리즘은 구현하기가 비교적 간단하며, 이해하기 쉽습니다.\"]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"단점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"유연성 부족\"}],\": 일정한 속도로만 요청을 처리할 수 있으므로, 일시적인 트래픽 증가에 유연하게 대응하기 어렵습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"버퍼 오버플로우\"}],\": 요청이 많이 들어올 경우 버킷이 가득 차서 새로운 요청을 버려야 할 수 있습니다. 이는 요청 손실을 의미합니다.\"]}],\"\\n\"]}],[\"$\",\"h4\",null,{\"children\":\"고정 윈도 카운터 (Fixed Window Counter) 알고리즘\"}],[\"$\",\"h5\",null,{\"children\":\"동작 원리\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"시간 윈도 설정\"}],\": 고정 윈도 카운터는 전체 시간을 동일한 크기의 '윈도'로 나눕니다. 예를 들어, 하루를 24개의 1시간짜리 윈도로 나눌 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"카운터\"}],\": 각 윈도마다 하나의 카운터가 있습니다. 요청이 들어올 때마다 해당 윈도의 카운터가 1씩 증가합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"요청 제한\"}],\": 각 윈도에 설정된 한계에 도달하면, 그 윈도에서는 더 이상 요청을 받지 않습니다. 새 윈도가 시작될 때까지 기다려야 합니다.\\n\",[\"$\",\"img\",null,{\"src\":\"/images/fixed_window_counter.png\",\"alt\":\"fixed_window_counter\"}]]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"장점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"단순성\"}],\": 구현하기 쉽고 이해하기 간단합니다. 복잡한 알고리즘이 필요 없는 작은 시스템이나 애플리케이션에 적합할 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"성능\"}],\": 카운터만 업데이트하면 되기 때문에, 매우 빠르고 효율적입니다.\"]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"단점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"버스트 트래픽 처리 어려움\"}],\": 윈도가 바뀔 때마다 요청 한도가 초기화되므로, 윈도가 바뀌는 순간에 요청이 몰리면 시스템에 큰 부하가 발생할 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"정확한 제한 어려움\"}],\": 정확한 초 단위로 요청을 제한하기 어렵습니다. 예를 들어, 1분 윈도에서 60개의 요청을 허용하는 경우, 첫 10초에 모든 요청이 몰릴 수도 있습니다.\"]}],\"\\n\"]}],[\"$\",\"h4\",null,{\"children\":\"이동 윈도 로그 (Sliding Window Log) 알고리즘\"}],[\"$\",\"h5\",null,{\"children\":\"동작 원리\"}],[\"$\",\"p\",null,{\"children\":\"이동 윈도 로그 알고리즘은 시간의 흐름에 따라 요청을 유연하게 처리할 수 있는 방법입니다. 이 알고리즘은 윈도의 고정된 크기를 유지하면서 시간이 지남에 따라 윈도를 '슬라이딩' 시키는 방식으로 작동합니다.\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"로그 기록\"}],\": 각 요청이 들어올 때, 그 요청의 타임스탬프를 로그에 기록합니다. 타임스탬프 데이터는 보통 Redis의 정렬 집합(sorted set)같은 캐시에 보관합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"이동 윈도\"}],\": 현재 시간을 기준으로 과거 일정 시간(예: 1분) 동안의 요청만을 고려합니다. 시간이 지나면서 이 윈도는 계속 앞으로 이동합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"윈도 업데이트\"}],\": 새로운 요청이 들어올 때마다 윈도를 업데이트하여, 오래된 요청을 윈도에서 제거하고 최근 요청을 포함시킵니다.\\n\",[\"$\",\"img\",null,{\"src\":\"/images/sliding_window_log.png\",\"alt\":\"sliding_window_log\"}]]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"장점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"유연성\"}],\": 이동 윈도 로그는 시간이 지남에 따라 요청을 더 유연하게 처리할 수 있어, 순간적인 트래픽 증가에도 잘 대응할 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"정밀한 제어\"}],\": 어느 순간의 윈도를 보더라도 허용되는 요청의 개수는 시스템의 처리율 한도를 넘지 않습니다.\"]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"단점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"자원 소모\"}],\": 각 요청의 타임스탬프를 저장하고 관리해야 하므로, 많은 요청을 처리하는 시스템에서는 메모리 사용량이 증가할 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"구현 복잡성\"}],\": 이동 윈도 로그 알고리즘은 다른 방법에 비해 구현이 복잡할 수 있으며, 정확한 시간 관리와 로그 처리가 필요합니다.\"]}],\"\\n\"]}],[\"$\",\"h4\",null,{\"children\":\"이동 윈도 카운터 (Sliding Window Counter) 알고리즘\"}],[\"$\",\"h5\",null,{\"children\":\"동작 원리\"}],[\"$\",\"p\",null,{\"children\":\"이동 윈도 카운터 알고리즘은 처리율을 제한하고, 시스템의 부하를 관리하는 데 사용되는 방법입니다. 이 알고리즘은 특히 동적인 웹 애플리케이션과 서비스에서 유용하게 사용됩니다.\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"시간 윈도\"}],\": 시간을 작은 단위로 나누어 각 단위마다 요청 수를 세는 카운터를 둡니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"이동\"}],\": 윈도는 시간이 지남에 따라 '이동'합니다. 즉, 새로운 시간 단위가 시작될 때마다 최신 요청을 반영하여 카운터를 업데이트합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"요청 제한\"}],\": 설정된 시간 동안 허용된 최대 요청 수를 넘으면, 추가 요청은 거부되거나 지연됩니다.\\n\",[\"$\",\"img\",null,{\"src\":\"/images/sliding_window_counter.png\",\"alt\":\"sliding_window_counter\"}]]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"장점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"이전 시간대의 평균 처리율에 따라 현재 윈도의 상태를 계산하므로 짧은 시간에 몰리는 트래픽에 잘 대응합니다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"정밀한 제어\"}],\": 시간 단위로 요청을 세밀하게 관리할 수 있어, 순간적인 트래픽 증가에도 유연하게 대응할 수 있습니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"효율적인 자원 사용\"}],\": 고정 윈도 카운터에 비해 더 많은 요청을 처리할 수 있으며, 자원을 보다 효율적으로 사용합니다.\"]}],\"\\n\"]}],[\"$\",\"h5\",null,{\"children\":\"단점\"}],[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"구현 복잡성\"}],\": 이동 윈도 카운터는 구현이 복잡할 수 있으며, 시간 관리와 카운터 업데이트에 주의가 필요합니다.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"메모리 사용량\"}],\": 각 시간 단위마다 카운터를 유지해야 하므로, 많은 요청을 처리하는 시스템에서는 메모리 사용량이 증가할 수 있습니다.\"]}],\"\\n\"]}]]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"구현\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"처리율 제한 로직의 신규 정책은 토큰 버킷알고리즘을 조금 변경하여 구현해야 했다.\\n정책은 다음과 같았다.\"}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"rate(초)동안 count(요청횟수)회 허용한다고 가정한다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"최초 요청이 들어왔을 때 rate(초) 타이머가 동작한다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"rate(초)범위 안에서는 count(요청횟수)회 연속으로 요청을 할 수 있다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"최초 요청으로부터 rate(초) 뒤 요청 할 수 있는 토큰이 한번에 생성된다. (count 개수만큼)\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"rate(초)안에 토큰을 전부 사용하지 못하더라도 토큰이 생성 될 때는 최대치인 count개를 넘지 않는다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"토큰을 전부 사용 했을 때 요청 거부와 다음 토큰이 생성되기까지 남은 시간을 반환한다.\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"rate(초)에 적용 할 수 있는 최소 주기는 0.00005초 이다.\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"위 알고리즘 방식은 특정 구간(토큰이 생성되는 시간 앞뒤)에서 최대 2n - 1개의 요청이 몰릴 수 있으니 참고하자.\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"처리율 제한 장치(rate limiter) 개선\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"rate limiter 개선 후 datadog에서 latency 그래프를 보았을 때 개선정도를 육안으로 확인 할 수 있었다.\\n\",[\"$\",\"img\",null,{\"src\":\"/images/ratelimit_result_latency.png\",\"alt\":\"ratelimit_result_latency\"}]]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"lua 스크립트 코드\"}],\"\\n\",[\"$\",\"figure\",null,{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",null,{\"style\":{\"backgroundColor\":\"#24292e\",\"color\":\"#e1e4e8\"},\"tabIndex\":\"0\",\"data-language\":\"lua\",\"data-theme\":\"github-dark\",\"children\":[\"$\",\"code\",null,{\"data-language\":\"lua\",\"data-theme\":\"github-dark\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" keys \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" redis.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"call\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'mget'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", KEYS[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"], KEYS[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 두 키의 값을 한번에 가져옴\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" tokens \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" tonumber\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(keys[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"or\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" tonumber\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(ARGV[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 현재 버킷의 토큰 개수\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" last_fill \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" tonumber\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(keys[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"or\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" tonumber\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(ARGV[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"3\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 마지막으로 토큰이 충전된 시간\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" capacity \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" tonumber\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(ARGV[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 버킷의 최대 토큰 수\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" refill_interval \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" tonumber\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(ARGV[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 토큰이 다시 채워지는 시간 간격 (초)\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" now \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" tonumber\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(ARGV[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"3\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 현재 시간\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" ttl \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" refill_interval \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"*\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" *\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 1000\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\" -- 넉넉하게 ttl값 설정 (초)\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 경과 시간 계산\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" elapsed \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" now \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"-\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" last_fill\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 충전 시간이 경과 했거나 첫 요청(elapsed == 0)인 경우 토큰을 최대로 채움\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"if\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" elapsed \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"\u003e=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" refill_interval \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"or\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" elapsed \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" then\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"    tokens \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" capacity\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"    redis.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"call\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'psetex'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", KEYS[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"], ttl, tokens)\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"    redis.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"call\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'psetex'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", KEYS[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"], ttl, now)\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"end\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"if\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" tokens \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"\u003e\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" then\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"    -- 토큰이 있는 경우, 토큰 하나 소모\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"    tokens \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" tokens \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"-\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 1\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"    redis.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"call\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'psetex'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", KEYS[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"], ttl, tokens)\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"    return\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" {\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", tokens, \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"} \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 요청 허용, 남은 토큰 수, 대기 시간 0초 반환\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"else\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"    -- 토큰이 없으면 다음 충전 시간까지 기다려야 함\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"    local\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" time_to_next_refill \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" refill_interval \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"-\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" elapsed\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"    return\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" {\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", tokens, time_to_next_refill} \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"-- 요청 거부, 남은 토큰 수, 대기 시간 반환\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"end\"}]}]]}]}]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"ratelimit.ts 코드\"}],\"\\n\",[\"$\",\"figure\",null,{\"data-rehype-pretty-code-figure\":\"\",\"children\":[\"$\",\"pre\",null,{\"style\":{\"backgroundColor\":\"#24292e\",\"color\":\"#e1e4e8\"},\"tabIndex\":\"0\",\"data-language\":\"typescript\",\"data-theme\":\"github-dark\",\"children\":[\"$\",\"code\",null,{\"data-language\":\"typescript\",\"data-theme\":\"github-dark\",\"style\":{\"display\":\"grid\"},\"children\":[[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"import\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" assert \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"from\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\" 'assert'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\";\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"type\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\" Rate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" [\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"number\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"number\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"];\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"type\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\" RateLimitResponse\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#FFAB70\"},\"children\":\"    available\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" boolean\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\";\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#FFAB70\"},\"children\":\"    retryAfter\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" number\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\";\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"}\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" TOKEN_BUCKET_BUST_FILL_ALGO\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\" 'lua script...'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\";\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"export\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" class\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\" RateLimitV2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"    static\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#FFAB70\"},\"children\":\" bustFillLuaScript\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" string\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" TOKEN_BUCKET_BUST_FILL_ALGO\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\";\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"    static\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#FFAB70\"},\"children\":\" bustFillLuaScriptHash\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" string\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" crypto\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"        .\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"createHash\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'sha1'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\")\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"        .\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"update\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"TOKEN_BUCKET_BUST_FILL_ALGO\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'utf8'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\")\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"        .\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"digest\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'hex'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\");\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"    // ...중략\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"    constructor\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"() {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"        \"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"        // ...중략\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"    }\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"    static\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" async\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\" ratelimit\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#FFAB70\"},\"children\":\"client\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\" RedisClientType\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#FFAB70\"},\"children\":\"keyPfx\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" string\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#FFAB70\"},\"children\":\"rate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\" Rate\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\")\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\" Promise\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"\u003c\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"RateLimitResponse\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"\u003e {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        if\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" (rate[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"===\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\") {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"            return\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"                available: \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"true\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"                retryAfter: \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"            };\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"        }\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"        assert\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0.0005\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" \u003c=\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" rate[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"], \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"'ratelimit time is too small'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\");\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"        // KEYS\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" baseKey\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\" `${\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"keyPfx\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"}.ratelimit`\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\";\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" keys\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" [\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"`${\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"baseKey\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"}.tokens`\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\", \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"`${\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"baseKey\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\"}.timestamp`\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"];\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#6A737D\"},\"children\":\"        // ARGS (인자값 순서 주의)\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" capacity\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" rate[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"].\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"toString\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"();\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" refillInterval\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" rate[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"].\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"toString\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"();\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" now\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" (Date.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"now\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"() \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"/\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 1000\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\").\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"toString\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"();\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" args\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" [capacity, refillInterval, now];\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" scriptLoaded\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" await\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" client.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"scriptExists\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(RateLimitV2.bustFillLuaScriptHash);\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        if\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" (\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"!\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"scriptLoaded[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"]) {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"            await\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" client.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"scriptLoad\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(RateLimitV2.bustFillLuaScript);\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"        }\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        const\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" result\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\":\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" any\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" =\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" await\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" client.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"evalSha\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(RateLimitV2.bustFillLuaScriptHash, {keys, arguments: args});\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"        assert\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(result.\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"length\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" ===\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 3\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\");\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"        assert\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(result[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"==\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" ||\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" result[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"===\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\");\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#B392F0\"},\"children\":\"        assert\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"(\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"typeof\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" result[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"===\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\" 'number'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" \u0026\u0026\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\" typeof\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" result[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"===\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#9ECBFF\"},\"children\":\" 'number'\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\");\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":\" \"}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"        return\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\" {\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"            available: result[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"0\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"===\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 1\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"            retryAfter: result[\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\"2\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"] \"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#F97583\"},\"children\":\"*\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#79B8FF\"},\"children\":\" 1000\"}],[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\",\"}]]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"        };\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"    }\"}]}],\"\\n\",[\"$\",\"span\",null,{\"data-line\":\"\",\"children\":[\"$\",\"span\",null,{\"style\":{\"color\":\"#E1E4E8\"},\"children\":\"}\"}]}]]}]}]}]]]}]}],null]]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"post\",\"children\",\"$7\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"post\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"__className_aaf875\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"$L9\",null,{\"children\":[[\"$\",\"$La\",null,{}],[\"$\",\"main\",null,{\"className\":\"transition duration-500 bg-white dark:bg-[#111111] text-black dark:text-white\",\"children\":[\"$\",\"div\",null,{\"className\":\"max-w-screen-md flex flex-col px-10 m-auto\",\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]}],[\"$\",\"footer\",null,{\"className\":\"w-full font-mono flex flex-col justify-center items-center pt-10 pb-6 transition duration-500 bg-white dark:bg-[#111111] dark:text-white text-black\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex justify-center gap-4 items-center pt-4 border-t-2 w-36\",\"children\":[[\"$\",\"a\",null,{\"href\":\"beenchangseo@gmail.com\",\"className\":\"hover:scale-110 transition-transform duration-500 hover:text-green-500 hover:fill-green-500 dark:fill-white dark:hover:fill-green-500\",\"children\":[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":\"24\",\"height\":\"24\",\"viewBox\":\"0 0 24 24\",\"children\":[\"$\",\"path\",null,{\"d\":\"M12 .02c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.99 6.98l-6.99 5.666-6.991-5.666h13.981zm.01 10h-14v-8.505l7 5.673 7-5.672v8.504z\"}]}]}],[\"$\",\"a\",null,{\"href\":\"https://github.com/beenchangseo\",\"className\":\"hover:scale-110 transition-transform duration-500 hover:text-green-500 hover:fill-green-500 dark:fill-white dark:hover:fill-green-500\",\"children\":[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"width\":\"24\",\"height\":\"24\",\"viewBox\":\"0 0 24 24\",\"children\":[\"$\",\"path\",null,{\"d\":\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"}]}]}]]}],[\"$\",\"div\",null,{\"className\":\"text-sm mt-2\",\"children\":\"Copyright © 2024 Changbeen seo\"}],[\"$\",\"div\",null,{\"className\":\"text-xs mt-2\",\"children\":\"beenchangseo\"}]]}]]}]}]}],null]],\"initialHead\":[false,\"$Lb\"],\"globalErrorComponent\":\"$c\",\"missingSlots\":\"$Wd\"}]]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"redis와 lua스크립트를 이용한 처리율 제한 장치 만들기\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"redis와 lua스크립트를 이용한 처리율 제한 장치를 만드는 포스팅입니다.\"}],[\"$\",\"meta\",\"4\",{\"name\":\"keywords\",\"content\":\"ratelimit, redis ratelimi, Rate limiting, Rate limiting lua, lua script, 처리율 제한장치\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:title\",\"content\":\"redis와 lua스크립트를 이용한 처리율 제한 장치 만들기\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:description\",\"content\":\"redis와 lua스크립트를 이용한 처리율 제한 장치를 만드는 포스팅입니다.\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:url\",\"content\":\"https://beenchangseo.github.io/redis_ratelimit_lua_script\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:site_name\",\"content\":\"Beenchangseo Blog\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:locale\",\"content\":\"ko_KR\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"11\",{\"property\":\"article:tag\",\"content\":\"ratelimit\"}],[\"$\",\"meta\",\"12\",{\"property\":\"article:tag\",\"content\":\"redis ratelimi\"}],[\"$\",\"meta\",\"13\",{\"property\":\"article:tag\",\"content\":\"Rate limiting\"}],[\"$\",\"meta\",\"14\",{\"property\":\"article:tag\",\"content\":\"Rate limiting lua\"}],[\"$\",\"meta\",\"15\",{\"property\":\"article:tag\",\"content\":\"lua script\"}],[\"$\",\"meta\",\"16\",{\"property\":\"article:tag\",\"content\":\"처리율 제한장치\"}],[\"$\",\"meta\",\"17\",{\"name\":\"twitter:card\",\"content\":\"summary\"}],[\"$\",\"meta\",\"18\",{\"name\":\"twitter:creator\",\"content\":\"beenchangseo\"}],[\"$\",\"meta\",\"19\",{\"name\":\"twitter:title\",\"content\":\"redis와 lua스크립트를 이용한 처리율 제한 장치 만들기\"}],[\"$\",\"meta\",\"20\",{\"name\":\"twitter:description\",\"content\":\"redis와 lua스크립트를 이용한 처리율 제한 장치를 만드는 포스팅입니다.\"}],[\"$\",\"meta\",\"21\",{\"name\":\"next-size-adjust\"}]]\n"])</script><script>self.__next_f.push([1,"5:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>